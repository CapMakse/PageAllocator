# Page Allocator

## Загальний принцип роботи

Вся пам'ять, яка доступна аллокатору, розділена на сторінки. Розмір сторінки може бути від 4Кбт до декількох мегабайт. Всі сторінки мають однаковий розмір.

Кожна сторінка поділена на блоки фіксованого розміру. Із самого початку роботи аллокатора, ніяка із сторінок не розмічена (розбита) на блоки. Форматування сторінки робиться під час роботи програми. Це пов'язано із тим, що ми не можемо знати на перед як саме розмісувати сторінки і блоки яких розмірів будуть найчатіше використовуватися.

Всі блоки поділяються на два типи:
1. розміром мерше ніж половина сторінки
2. розміром більше половини сторінки

Кожна сторінка може бути тільки в трьох станах: розділена на блоки, зайнята багатосторінковим блоком, та вільна.

Аллокатор збегірає наступні дані про сторінки:
* дескриптор який існує для кожної розміченгої сторінки. Дескриптор включає в себе вказівник на перший вільний блок на сторінці та кількість вільних блоків. У своїй реалізації я також включав розмір блоку сторінки. Всі дескриптори я зберігав у масиві.
* Словник із списками сторінок, в яких є як мінімум один вільний блок. (Як ключ я брав розмір блоку, як значення список дескрипторів не повних сторінок)

На самій сторінці всі вільні блоки утворюють список. Тобто, якщо блок вільний, то ми можемо записати в нього адресу на наступний вільний блок, і це нікому не помішає, бо цей блок вільний. Дескриптор зберагіє вказівник на перший вильний блок. Коли ми віддаємо якись блок на роботу, то дескриптор просто запам'ятовує наспуний блок із списку. Коли ми очищуємо якийсь блок, то той блок дописується в початок списку, а дескриптор починає вказувати на нього.

# MemAlloc

Спочатку розмір запрошуваної пам'яті `size` потрібно округлити:
* до першого більшого розміру блоку, якщо `size` менше половини сторінки
* до цільї кількості сторінок, якщо `size` більше ніж пів сторінки

Якщо перший випадок:
Після цього ми шукаємо в нашому словнику дескриптор сторінки, в якій є вільне місце. Якщо її не має, то ми беремо не розмічену сторінку та розмічуємо її блоками потрібного розміру та додаємо її дескриптор в Словник. Після того, як вибрали сторінку, із її дескриптора запам'ятовується окремо адреса першого вільного блоку (яка адреса повернеться користувачеві) та зменшується лічильник вільних блоків на -1. Після цього оновляємо вказівник на перший вільний блок в дескрипторі. Якщо вільних блоків на сторінці більш не має (це можна по лічильний глянути легко), тоді ми видаляємо цю сторінку з словнику.

Якщо другий випадок:
Дивимося в словнику чи є вільні сторінки у необхідній нам кількості. Якщо є, то беремо їх. Якщо ні, то беремо стільки вільних сторінок, скільки треба, створюємо дескриптор для кожної з них. В першому дескрипторі вказуємо повний розмір блоку (тобто розмір цих декількох сторінок рязом узятих). Решта дескрипторів просто для кількості. Користувачеві повертаємо вказівник на початок першої сторінки із взятих.

# MemFree

По переданому вказівникові визначаємо номер сторінки. Маючи номер, шукаємо дескриптор сторінки. В дескрипторі сторінки ми збільшуємо лічильник на +1 та встановлюємо вказівник першиого вільного блоку на видалений блок.

Тут 2 випадки
* видаляємо блок з повної сторінки
* видаляємо блок з сторінки з вільними блоками

Якщо перший випадок:
Додаємо дескриптор в словник.

Якщо другий випадок:
У новий перший вільний блок записуємо адресу попереднього першого вільного блока.

# MemReAlloc

Спочатку за допомогую MemAlloc намагаємося створити новий блок нового розміру. Якщо виходить, то переносимо дані зі старого блоку в новий та видаляємо старий за допомогою MemFree. Інакше, вертаємо null. 
